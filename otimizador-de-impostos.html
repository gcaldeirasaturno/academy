<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Otimização Tributária</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #analysisDetails ul, #actionableTips ul {
            list-style: none;
            padding-left: 0;
        }
        #analysisDetails li, #actionableTips li {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.75rem; /* 12px */
            font-size: 0.875rem; /* text-sm */
            color: #cbd5e1; /* slate-300 */
        }
        #analysisDetails li .fa-check-circle, #actionableTips li .fa-check-circle {
            color: #34d399; /* green-400 */
            margin-right: 0.5rem; /* 8px */
            margin-top: 0.125rem; /* 2px to align better with text */
        }
         #analysisDetails li .fa-times-circle, #actionableTips li .fa-times-circle {
            color: #fbbf24; /* amber-400 */
            margin-right: 0.5rem; /* 8px */
            margin-top: 0.125rem;
        }
        #analysisDetails li .fa-info-circle, #actionableTips li .fa-info-circle {
            color: #60a5fa; /* blue-400 */
            margin-right: 0.5rem; /* 8px */
            margin-top: 0.125rem;
        }
         #actionableTips li .fa-lightbulb {
            color: #facc15; /* yellow-400 */
            margin-right: 0.5rem;
            margin-top: 0.125rem;
        }
         #actionableTips li .fa-exclamation-triangle {
            color: #f87171; /* red-400 */
            margin-right: 0.5rem;
            margin-top: 0.125rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 text-gray-100 min-h-screen flex flex-col items-center justify-center p-4 selection:bg-sky-500 selection:text-white">

    <div class="bg-slate-800 shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-3xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-400">Calculadora de Otimização Tributária</h1>
            <p class="text-slate-400 mt-2">Descubra o regime tributário mais vantajoso para sua empresa.</p>
        </header>

        <form id="taxForm" class="space-y-6">
            <div>
                <h2 class="text-xl font-semibold text-sky-500 border-b border-slate-700 pb-2 mb-4">Dados da Empresa</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="faturamentoMensal" class="block text-sm font-medium text-slate-300">Faturamento Mensal</label>
                        <input type="text" id="faturamentoMensal" name="faturamentoMensal" required inputmode="numeric" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm text-white" placeholder="R$ 0,00">
                    </div>
                    <div>
                        <label for="regimeAtualInput" class="block text-sm font-medium text-slate-300">Seu Regime Tributário Atual</label>
                        <select id="regimeAtualInput" name="regimeAtualInput" required class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm text-white">
                            <option value="simples_nacional">Simples Nacional</option>
                            <option value="lucro_presumido">Lucro Presumido</option>
                            <option value="lucro_real">Lucro Real</option>
                        </select>
                    </div>
                    <div>
                        <label for="setor" class="block text-sm font-medium text-slate-300">Setor de Atuação</label>
                        <select id="setor" name="setor" required class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm text-white">
                            <option value="comercio">Comércio</option>
                            <option value="industria">Indústria</option>
                            <option value="servicos">Serviços (Geral)</option>
                            <option value="tecnologia">Tecnologia (Serviços)</option>
                            <option value="construcao">Construção Civil (Obras)</option>
                            <option value="alimentacao_venda">Alimentação (Venda)</option>
                            <option value="transporte_passageiros">Transporte de Passageiros</option>
                            <option value="saude">Saúde (Serviços)</option>
                        </select>
                    </div>
                    <div>
                        <label for="estado" class="block text-sm font-medium text-slate-300">Estado (UF)</label>
                        <select id="estado" name="estado" required class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm text-white">
                           <option value="AC">AC</option> <option value="AL">AL</option> <option value="AP">AP</option> <option value="AM">AM</option> <option value="BA">BA</option> <option value="CE">CE</option> <option value="DF">DF</option> <option value="ES">ES</option> <option value="GO">GO</option> <option value="MA">MA</option> <option value="MT">MT</option> <option value="MS">MS</option> <option value="MG">MG</option> <option value="PA">PA</option> <option value="PB">PB</option> <option value="PR">PR</option> <option value="PE">PE</option> <option value="PI">PI</option> <option value="RJ">RJ</option> <option value="RN">RN</option> <option value="RS">RS</option> <option value="RO">RO</option> <option value="RR">RR</option> <option value="SC">SC</option> <option value="SP" selected>SP</option> <option value="SE">SE</option> <option value="TO">TO</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-xl font-semibold text-sky-500 border-b border-slate-700 pb-2 mb-4">Custos e Despesas Mensais</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="folhaSalarial" class="block text-sm font-medium text-slate-300">Gasto com Folha Salarial</label>
                        <input type="text" id="folhaSalarial" name="folhaSalarial" required inputmode="numeric" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm text-white" placeholder="R$ 0,00">
                    </div>
                     <div>
                        <label for="numFuncionarios" class="block text-sm font-medium text-slate-300">Número de Funcionários</label>
                        <input type="number" id="numFuncionarios" name="numFuncionarios" required class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm text-white" placeholder="Ex: 5">
                    </div>
                    <div>
                        <label for="comprasInsumos" class="block text-sm font-medium text-slate-300">
                            Custos de Mercadorias/Insumos Vendidos
                            <span class="tooltip text-sky-400">(?)
                                <span class="tooltiptext">Informe o CUSTO das mercadorias, produtos ou insumos diretos utilizados nos serviços/produtos vendidos no mês. Essencial para Lucro Real.</span>
                            </span>
                        </label>
                        <input type="text" id="comprasInsumos" name="comprasInsumos" required inputmode="numeric" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm text-white" placeholder="R$ 0,00">
                    </div>
                    <div>
                        <label for="despesasOperacionais" class="block text-sm font-medium text-slate-300">Despesas Operacionais
                            <span class="tooltip text-sky-400">(?)
                                <span class="tooltiptext">Ex: aluguel, luz, internet, marketing, etc. Não inclua folha, compras ou serviços de PJ já informados.</span>
                            </span>
                        </label>
                        <input type="text" id="despesasOperacionais" name="despesasOperacionais" required inputmode="numeric" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm text-white" placeholder="R$ 0,00">
                    </div>
                    <div class="md:col-span-2">
                        <label for="servicosTerceirosValor" class="block text-sm font-medium text-slate-300">
                            Valor de Serviços Tomados de PJ com NF
                            <span class="tooltip text-sky-400">(?)
                                <span class="tooltiptext">Informe o valor mensal de serviços contratados de outras empresas (PJ) com emissão de nota fiscal. Relevante para créditos de PIS/COFINS no Lucro Real.</span>
                            </span>
                        </label>
                        <input type="text" id="servicosTerceirosValor" name="servicosTerceirosValor" inputmode="numeric" value="" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm text-white" placeholder="R$ 0,00">
                    </div>
                </div>
            </div>
            
            <div class="pt-2">
                <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Analisar Regimes
                </button>
            </div>
        </form>

        <div id="loading" class="hidden loader"></div>

        <div id="results" class="mt-10 hidden">
            <h2 class="text-2xl font-semibold text-sky-400 border-b border-slate-700 pb-2 mb-6">Resultado da Análise</h2>
            
            <div id="mainMessage" class="mb-6 text-center bg-slate-700 p-4 rounded-lg">
                </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div id="currentRegimeCard" class="bg-slate-700 p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-slate-200 mb-1">Seu Regime Atual (<span id="currentRegimeName"></span>)</h3>
                    <p class="text-2xl font-bold text-amber-400">R$ <span id="currentTaxMonthly">0,00</span> <span class="text-sm font-normal text-slate-400">/mês</span></p>
                    <p class="text-slate-400">Alíquota Efetiva: <span id="currentAliqEfetiva">0.00</span>%</p>
                    <p class="text-slate-400 mt-1">Total Anual: R$ <span id="currentTaxAnnual">0,00</span></p>
                </div>
                <div id="recommendedRegimeCard" class="bg-slate-700 p-6 rounded-lg shadow hidden"> <h3 class="text-lg font-semibold text-slate-200 mb-1">Regime Recomendado (<span id="recommendedRegimeName"></span>)</h3>
                    <p class="text-2xl font-bold text-green-400">R$ <span id="recommendedTaxMonthly">0,00</span> <span class="text-sm font-normal text-slate-400">/mês</span></p>
                    <p class="text-slate-400">Alíquota Efetiva: <span id="recommendedAliqEfetiva">0.00</span>%</p>
                    <p class="text-slate-400 mt-1">Total Anual: R$ <span id="recommendedTaxAnnual">0,00</span></p>
                </div>
            </div>

            <div id="economiaSection" class="bg-sky-700/30 p-6 rounded-lg shadow text-center hidden"> <h3 class="text-xl font-semibold text-sky-300 mb-2">Economia Estimada com Mudança</h3>
                <p class="text-3xl font-bold text-white">R$ <span id="economiaValor">0,00</span> <span class="text-lg font-normal text-slate-300">/mês</span></p>
                <p class="text-xl font-bold text-green-300">(<span id="economiaPercentual">0.00</span>%)</p>
                <p class="text-slate-300 mt-1">Totalizando R$ <span id="economiaAnual">0,00</span> de economia anual!</p>
            </div>

            <div id="analysisDetails" class="mt-8 p-6 bg-slate-700/50 rounded-lg shadow hidden">
                <h3 class="text-lg font-semibold text-sky-400 mb-4">Análise Detalhada dos Resultados:</h3>
                <ul id="analysisPoints" class="space-y-2"></ul>
            </div>

            <div id="actionableTips" class="mt-8 p-6 bg-slate-700/50 rounded-lg shadow hidden">
                <h3 class="text-lg font-semibold text-sky-400 mb-4">Próximos Passos e Dicas:</h3>
                <ul id="tipPoints" class="space-y-2"></ul>
            </div>
            
            <div class="mt-8 text-center">
                 <a href="https://wa.me/55XXXXXXXXXXX?text=Ol%C3%A1%2C%20fiz%20uma%20simula%C3%A7%C3%A3o%20na%20calculadora%20e%20gostaria%20de%20falar%20com%20um%20consultor." 
                    target="_blank" 
                    class="inline-block bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Fale com um Consultor
                </a>
            </div>

            <div class="mt-8 text-xs text-slate-500 text-center">
                <p><strong>Aviso:</strong> Esta calculadora fornece uma estimativa e não substitui o aconselhamento de um contador profissional...</p>
            </div>
        </div>
    </div>

    <footer class="text-center mt-12 pb-6">
        <p class="text-sm text-slate-500">&copy; <span id="currentYear"></span> Sua Empresa Contábil. Todos os direitos reservados.</p>
    </footer>

<script>
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    function formatCurrencyInput(event) { /* ... (mantido igual) ... */ 
        const input = event.target;
        let value = input.value;
        let numericValue = value.replace(/\D/g, '');
        if (numericValue === "") { input.value = ""; return; }
        let number = parseInt(numericValue, 10);
        let formattedValue = (number / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        input.value = formattedValue;
    }
    function getNumericValueFromInput(elementId) { /* ... (mantido igual) ... */ 
        const inputElement = document.getElementById(elementId);
        if (!inputElement) return 0;
        let value = inputElement.value;
        value = value.replace(/R\$\s*/g, '').replace(/\./g, '').replace(',', '.');
        const numeric = parseFloat(value);
        return isNaN(numeric) ? 0 : numeric;
    }
    const currencyInputIds = ['faturamentoMensal', 'folhaSalarial', 'comprasInsumos', 'despesasOperacionais', 'servicosTerceirosValor'];
    currencyInputIds.forEach(id => { /* ... (mantido igual) ... */ 
        const inputElement = document.getElementById(id);
        if (inputElement) {
            inputElement.addEventListener('input', formatCurrencyInput);
            inputElement.addEventListener('blur', formatCurrencyInput);
        }
    });

    const SIMPLES_NACIONAL_LIMITE_ANUAL = 4800000;
    const SIMPLES_NACIONAL_SUBLIMITE_ANUAL_ICMS_ISS = 3600000;

    const SIMPLES_NACIONAL_TABELAS = { /* ... (mantido igual) ... */ 
        ANEXO_I_COMERCIO: [ { ate: 180000, aliquota: 0.04, deduzir: 0 }, { ate: 360000, aliquota: 0.073, deduzir: 5940 }, { ate: 720000, aliquota: 0.095, deduzir: 13860 }, { ate: 1800000, aliquota: 0.107, deduzir: 22500 }, { ate: 3600000, aliquota: 0.143, deduzir: 87300 }, { ate: 4800000, aliquota: 0.19, deduzir: 378000 } ],
        ANEXO_II_INDUSTRIA: [ { ate: 180000, aliquota: 0.045, deduzir: 0 }, { ate: 360000, aliquota: 0.078, deduzir: 5940 }, { ate: 720000, aliquota: 0.10, deduzir: 13860 }, { ate: 1800000, aliquota: 0.112, deduzir: 22500 }, { ate: 3600000, aliquota: 0.147, deduzir: 87300 }, { ate: 4800000, aliquota: 0.30, deduzir: 720000 } ],
        ANEXO_III_SERVICOS: [ { ate: 180000, aliquota: 0.06, deduzir: 0 }, { ate: 360000, aliquota: 0.112, deduzir: 9360 }, { ate: 720000, aliquota: 0.135, deduzir: 17640 }, { ate: 1800000, aliquota: 0.16, deduzir: 35640 }, { ate: 3600000, aliquota: 0.21, deduzir: 125640 }, { ate: 4800000, aliquota: 0.33, deduzir: 648000 } ],
        ANEXO_IV_SERVICOS_OBRAS: [ { ate: 180000, aliquota: 0.045, deduzir: 0 }, { ate: 360000, aliquota: 0.09, deduzir: 8100 }, { ate: 720000, aliquota: 0.102, deduzir: 12420 }, { ate: 1800000, aliquota: 0.14, deduzir: 39780 }, { ate: 3600000, aliquota: 0.22, deduzir: 183780 }, { ate: 4800000, aliquota: 0.33, deduzir: 828000 } ],
        ANEXO_V_SERVICOS: [ { ate: 180000, aliquota: 0.155, deduzir: 0 }, { ate: 360000, aliquota: 0.18, deduzir: 4500 }, { ate: 720000, aliquota: 0.195, deduzir: 9900 }, { ate: 1800000, aliquota: 0.205, deduzir: 17100 }, { ate: 3600000, aliquota: 0.23, deduzir: 62100 }, { ate: 4800000, aliquota: 0.305, deduzir: 540000 } ]
    };
    const ALIQUOTAS_LUCRO_PRESUMIDO = { IRPJ_PRESUNCAO: { comercio: 0.08, industria: 0.08, servicos: 0.32, tecnologia: 0.32, construcao: 0.32, alimentacao_venda: 0.08, transporte_passageiros: 0.16, saude: 0.32 }, CSLL_PRESUNCAO: { comercio: 0.12, industria: 0.12, servicos: 0.32, tecnologia: 0.32, construcao: 0.32, alimentacao_venda: 0.12, transporte_passageiros: 0.12, saude: 0.32 }, IRPJ_ALIQUOTA: 0.15, IRPJ_ADICIONAL_LIMITE_MENSAL: 20000, IRPJ_ADICIONAL_ALIQUOTA: 0.10, CSLL_ALIQUOTA: 0.09, PIS_COFINS_CUMULATIVO: 0.0365, ISS_MEDIA: 0.035, ICMS_MEDIA: 0.03 };
    const ALIQUOTAS_LUCRO_REAL = { IRPJ_ALIQUOTA: 0.15, IRPJ_ADICIONAL_LIMITE_MENSAL: 20000, IRPJ_ADICIONAL_ALIQUOTA: 0.10, CSLL_ALIQUOTA: 0.09, PIS_NAO_CUMULATIVO: 0.0165, COFINS_NAO_CUMULATIVO: 0.076, INSS_PATRONAL_GERAL: 0.20, ISS_MEDIA: 0.035, ICMS_MEDIA_DEBITO: 0.18, ICMS_MEDIA_CREDITO: 0.18 };

    function calcularSimplesNacional(inputs) { 
        const rbt12 = inputs.faturamentoMensal * 12;
        let excedeuLimiteTotalSN = rbt12 > SIMPLES_NACIONAL_LIMITE_ANUAL;

        // Se o limite total foi excedido, retorna imediatamente.
        if (excedeuLimiteTotalSN) {
            return { regimeKey: 'simples_nacional', mensal: Infinity, anual: Infinity, nome: "Simples Nacional (Faturamento Excede Limite Total)", aliquotaEfetiva: 0, componentes: { das: Infinity }, excedeuLimiteTotal: true, excedeuSublimite: rbt12 > SIMPLES_NACIONAL_SUBLIMITE_ANUAL_ICMS_ISS };
        }

        let anexoTabela; let anexoNome = ""; let impostoMensal = 0;
        let setorOriginal = inputs.setor; 

        switch (inputs.setor) {
            case 'comercio': case 'alimentacao_venda': anexoTabela = SIMPLES_NACIONAL_TABELAS.ANEXO_I_COMERCIO; anexoNome = "Anexo I (Comércio)"; break;
            case 'industria': anexoTabela = SIMPLES_NACIONAL_TABELAS.ANEXO_II_INDUSTRIA; anexoNome = "Anexo II (Indústria)"; break;
            case 'servicos': case 'tecnologia': case 'saude': case 'transporte_passageiros':
                const fatorR = inputs.faturamentoMensal > 0 ? inputs.folhaSalarial / inputs.faturamentoMensal : 0;
                if (fatorR >= 0.28 || inputs.setor === 'transporte_passageiros') {
                    anexoTabela = SIMPLES_NACIONAL_TABELAS.ANEXO_III_SERVICOS;
                    anexoNome = `Anexo III (Serviços - Fator R ${fatorR >= 0.28 ? '>=28%' : inputs.setor === 'transporte_passageiros' ? '(Transp.)' : 'N/A'})`;
                } else {
                    anexoTabela = SIMPLES_NACIONAL_TABELAS.ANEXO_V_SERVICOS;
                    anexoNome = `Anexo V (Serviços - Fator R <28%)`;
                }
                break;
            case 'construcao': anexoTabela = SIMPLES_NACIONAL_TABELAS.ANEXO_IV_SERVICOS_OBRAS; anexoNome = "Anexo IV (Construção)"; break;
            default: return { regimeKey: 'simples_nacional', mensal: Infinity, anual: Infinity, nome: "Simples Nacional (Setor não mapeado)", aliquotaEfetiva: 0, componentes: { das: 0, cppAnexoIV: 0, issAnexoIV: 0 }, excedeuLimiteTotal: false, excedeuSublimite: false };
        }
        let aliquotaNominal = 0; let parcelaDeduzir = 0;
        for (const faixa of anexoTabela) { if (rbt12 <= faixa.ate) { aliquotaNominal = faixa.aliquota; parcelaDeduzir = faixa.deduzir; break; } }
        if (aliquotaNominal === 0 && anexoTabela.length > 0) { const u = anexoTabela[anexoTabela.length -1]; aliquotaNominal = u.aliquota; parcelaDeduzir = u.deduzir; }
        
        const aliquotaEfetivaCalculada = rbt12 > 0 ? ((rbt12 * aliquotaNominal) - parcelaDeduzir) / rbt12 : 0;
        let dasMensalBase = inputs.faturamentoMensal * aliquotaEfetivaCalculada;
        
        let cppAnexoIV = 0; 
        let issAnexoIV = 0; 
        let icmsPorForaSublimite = 0;
        let issPorForaSublimite = 0;
        let excedeuSublimite = rbt12 > SIMPLES_NACIONAL_SUBLIMITE_ANUAL_ICMS_ISS;

        if (inputs.setor === 'construcao') { 
            cppAnexoIV = inputs.folhaSalarial * ALIQUOTAS_LUCRO_REAL.INSS_PATRONAL_GERAL;
            issAnexoIV = inputs.faturamentoMensal * ALIQUOTAS_LUCRO_PRESUMIDO.ISS_MEDIA; 
            impostoMensal = dasMensalBase + cppAnexoIV + issAnexoIV;
            anexoNome += " + CPP + ISS";
        } else {
            impostoMensal = dasMensalBase;
        }

        if (excedeuSublimite && inputs.setor !== 'construcao') {
            if (['comercio', 'industria', 'alimentacao_venda'].includes(setorOriginal)) {
                icmsPorForaSublimite = inputs.faturamentoMensal * ALIQUOTAS_LUCRO_PRESUMIDO.ICMS_MEDIA;
                impostoMensal += icmsPorForaSublimite; 
                anexoNome += " + ICMS (sublimite)";
            } else if (['servicos', 'tecnologia', 'saude', 'transporte_passageiros'].includes(setorOriginal)) {
                issPorForaSublimite = inputs.faturamentoMensal * ALIQUOTAS_LUCRO_PRESUMIDO.ISS_MEDIA;
                impostoMensal += issPorForaSublimite; 
                anexoNome += " + ISS (sublimite)";
            }
        }
        
        impostoMensal = impostoMensal > 0 ? impostoMensal : 0;
        const aliquotaEfetivaFinal = inputs.faturamentoMensal > 0 ? (impostoMensal / inputs.faturamentoMensal) * 100 : 0;
        
        return { 
            regimeKey: 'simples_nacional', 
            mensal: impostoMensal, 
            anual: impostoMensal * 12, 
            nome: `Simples Nacional (${anexoNome})`, 
            aliquotaEfetiva: aliquotaEfetivaFinal, 
            componentes: { 
                das: dasMensalBase, 
                cppAnexoIV: cppAnexoIV, 
                issAnexoIV: issAnexoIV, 
                icmsPorForaSublimite: icmsPorForaSublimite,
                issPorForaSublimite: issPorForaSublimite,
                pisCofins: (inputs.setor !== 'construcao' ? dasMensalBase * 0.40 : 0), 
                irpjCsll: (inputs.setor !== 'construcao' ? dasMensalBase * 0.15 : 0)  
            },
            excedeuLimiteTotal: excedeuLimiteTotalSN, 
            excedeuSublimite: excedeuSublimite
        };
    }

    function calcularLucroPresumido(inputs) { /* ... (mantido igual) ... */ 
        const f = inputs.faturamentoMensal; const s = inputs.setor;
        const baseIRPJ = f * ALIQUOTAS_LUCRO_PRESUMIDO.IRPJ_PRESUNCAO[s];
        const baseCSLL = f * ALIQUOTAS_LUCRO_PRESUMIDO.CSLL_PRESUNCAO[s];
        let irpj = baseIRPJ * ALIQUOTAS_LUCRO_PRESUMIDO.IRPJ_ALIQUOTA;
        if (baseIRPJ > ALIQUOTAS_LUCRO_PRESUMIDO.IRPJ_ADICIONAL_LIMITE_MENSAL) { irpj += (baseIRPJ - ALIQUOTAS_LUCRO_PRESUMIDO.IRPJ_ADICIONAL_LIMITE_MENSAL) * ALIQUOTAS_LUCRO_PRESUMIDO.IRPJ_ADICIONAL_ALIQUOTA; }
        const csll = baseCSLL * ALIQUOTAS_LUCRO_PRESUMIDO.CSLL_ALIQUOTA;
        const pisCofins = f * ALIQUOTAS_LUCRO_PRESUMIDO.PIS_COFINS_CUMULATIVO;
        let impostoMunicipalEstadual = 0; 
        if (['comercio', 'industria', 'alimentacao_venda'].includes(s)) { impostoMunicipalEstadual = f * ALIQUOTAS_LUCRO_PRESUMIDO.ICMS_MEDIA; } 
        else { impostoMunicipalEstadual = f * ALIQUOTAS_LUCRO_PRESUMIDO.ISS_MEDIA; }
        const totalMensal = irpj + csll + pisCofins + impostoMunicipalEstadual;
        const aliquotaEfetiva = f > 0 ? (totalMensal / f) * 100 : 0;
        return { regimeKey: 'lucro_presumido', mensal: totalMensal, anual: totalMensal * 12, nome: "Lucro Presumido", aliquotaEfetiva: aliquotaEfetiva, componentes: { pisCofins: pisCofins, irpjCsll: irpj + csll, inssPatronal: inputs.folhaSalarial * ALIQUOTAS_LUCRO_REAL.INSS_PATRONAL_GERAL, outrosImpostos: impostoMunicipalEstadual, baseIrpj: baseIRPJ, baseCsll: baseCSLL } };
    }

    function calcularLucroReal(inputs) { /* ... (mantido igual) ... */ 
        const f = inputs.faturamentoMensal; 
        const c = inputs.comprasInsumos; 
        const fl = inputs.folhaSalarial;
        const dOp = inputs.despesasOperacionais; 
        const sTV = inputs.servicosTerceirosValor;
        const pisDebito = f * ALIQUOTAS_LUCRO_REAL.PIS_NAO_CUMULATIVO; 
        const cofinsDebito = f * ALIQUOTAS_LUCRO_REAL.COFINS_NAO_CUMULATIVO;
        const creditoPisCompras = c * ALIQUOTAS_LUCRO_REAL.PIS_NAO_CUMULATIVO; 
        const creditoCofinsCompras = c * ALIQUOTAS_LUCRO_REAL.COFINS_NAO_CUMULATIVO;
        const creditoPisServicos = sTV * ALIQUOTAS_LUCRO_REAL.PIS_NAO_CUMULATIVO; 
        const creditoCofinsServicos = sTV * ALIQUOTAS_LUCRO_REAL.COFINS_NAO_CUMULATIVO;
        const pisAPagar = Math.max(0, pisDebito - creditoPisCompras - creditoPisServicos); 
        const cofinsAPagar = Math.max(0, cofinsDebito - creditoCofinsCompras - creditoCofinsServicos);
        const totalPisCofins = pisAPagar + cofinsAPagar;
        const inssPatronal = fl * ALIQUOTAS_LUCRO_REAL.INSS_PATRONAL_GERAL;
        const lair = f - c - fl - dOp - totalPisCofins; 
        let irpj = 0; let csll = 0;
        if (lair > 0) { 
            irpj = lair * ALIQUOTAS_LUCRO_REAL.IRPJ_ALIQUOTA; 
            if (lair > ALIQUOTAS_LUCRO_REAL.IRPJ_ADICIONAL_LIMITE_MENSAL) { 
                irpj += (lair - ALIQUOTAS_LUCRO_REAL.IRPJ_ADICIONAL_LIMITE_MENSAL) * ALIQUOTAS_LUCRO_REAL.IRPJ_ADICIONAL_ALIQUOTA; 
            }
            csll = lair * ALIQUOTAS_LUCRO_REAL.CSLL_ALIQUOTA; 
        }
        const totalIrpjCsll = irpj + csll;
        let impostoMunicipalEstadual = 0; 
        if (['comercio', 'industria', 'alimentacao_venda'].includes(inputs.setor)) {
            const debICMS = f * ALIQUOTAS_LUCRO_REAL.ICMS_MEDIA_DEBITO; 
            const credICMS = c * ALIQUOTAS_LUCRO_REAL.ICMS_MEDIA_CREDITO;
            impostoMunicipalEstadual = Math.max(0, debICMS - credICMS);
        } else { 
            impostoMunicipalEstadual = f * ALIQUOTAS_LUCRO_REAL.ISS_MEDIA; 
        }
        const totalMensal = totalIrpjCsll + totalPisCofins + inssPatronal + impostoMunicipalEstadual;
        const aliquotaEfetiva = f > 0 ? (totalMensal / f) * 100 : 0;
        return { regimeKey: 'lucro_real', mensal: totalMensal, anual: totalMensal * 12, nome: "Lucro Real", aliquotaEfetiva: aliquotaEfetiva, componentes: { pisCofins: totalPisCofins, irpjCsll: totalIrpjCsll, inssPatronal: inssPatronal, outrosImpostos: impostoMunicipalEstadual, creditosPisCofins: creditoPisCompras + creditoCofinsCompras + creditoPisServicos + creditoCofinsServicos, lairApurado: lair } };
    }

    function gerarAnaliseDetalhada(inputs, regimeAtualData, regimeRecomendadoData, economiaMensal, simplesExcedeuSublimite, simplesExcedeuLimiteTotalUsuario) {
        const analysisPointsEl = document.getElementById('analysisPoints');
        analysisPointsEl.innerHTML = ''; 
        const points = [];
        const formatOpt = { minimumFractionDigits: 2, maximumFractionDigits: 2 };

        if (simplesExcedeuLimiteTotalUsuario) { // Se o regime ATUAL do usuário era SN e ele excedeu o limite
            points.push(`<li><i class="fas fa-exclamation-triangle text-red-400"></i>Seu regime atual (Simples Nacional) não é válido devido ao faturamento exceder o limite de R$ 4,8 milhões anuais.</li>`);
            points.push(`<li><i class="fas fa-info-circle"></i>O regime recomendado (<strong class="text-green-300">${regimeRecomendadoData.nome}</strong>) foi determinado comparando Lucro Presumido e Lucro Real.</li>`);
        } else if (regimeAtualData.regimeKey === regimeRecomendadoData.regimeKey && !simplesExcedeuSublimite) {
             points.push(`<li><i class="fas fa-info-circle"></i>Seu regime atual (<strong class="text-sky-300">${regimeAtualData.nome}</strong>) já se mostra o mais vantajoso nesta simulação.</li>`);
            // ... (outras justificativas mantidas)
        } else { 
             points.push(`<li><i class="fas ${economiaMensal > 0 ? 'fa-check-circle' : 'fa-info-circle'}"></i>Comparando seu regime atual (<strong class="text-amber-300">${regimeAtualData.nome}</strong>) com o regime recomendado (<strong class="text-green-300">${regimeRecomendadoData.nome}</strong>):</li>`);
            // ... (comparações de componentes mantidas)
        }
        // ... (restante da função gerarAnaliseDetalhada mantida, incluindo a checagem do sublimite)
         if (simplesExcedeuSublimite && !(simplesExcedeuLimiteTotalUsuario && regimeAtualData.regimeKey === 'simples_nacional')) { // Só mostra aviso de sublimite se não for o caso de limite total já estourado E SN sendo o regime atual
            points.push(`<li><i class="fas fa-exclamation-triangle text-amber-400"></i><strong>Atenção ao Sublimite do Simples Nacional:</strong> Seu faturamento anualizado ultrapassou R$ 3,6 milhões. Se optar pelo Simples, o ICMS/ISS pode precisar ser recolhido por fora do DAS.</li>`);
        }
        analysisPointsEl.innerHTML = points.join('');
    }
    
    function gerarDicasTributarias(inputs, regimeAtualData, regimeRecomendadoData, economiaMensal, simplesExcedeuLimiteTotalUsuario, simplesExcedeuSublimite) {
        const tipPointsEl = document.getElementById('tipPoints');
        tipPointsEl.innerHTML = '';
        const tips = [];
        const formatOpt = { minimumFractionDigits: 2, maximumFractionDigits: 2 };

        if (simplesExcedeuLimiteTotalUsuario) { // Prioridade máxima se o regime atual do usuário (SN) estourou o limite
             tips.push(`<li><i class="fas fa-exclamation-triangle"></i><strong>URGENTE:</strong> Seu faturamento anualizado ultrapassa o limite do Simples Nacional (R$ 4,8 milhões). Como seu regime atual é Simples Nacional, sua empresa <strong>PRECISA</strong> ser reenquadrada para ${regimeRecomendadoData.nome} (ou o outro regime não SN, se aplicável) para evitar multas e problemas com a Receita Federal. Consulte seu contador imediatamente!</li>`);
        } else if (regimeAtualData.regimeKey !== regimeRecomendadoData.regimeKey && economiaMensal > 0) {
            tips.push(`<li><i class="fas fa-lightbulb"></i>Considere avaliar a mudança para o <strong class="text-sky-300">${regimeRecomendadoData.nome}</strong>. A economia estimada de R$ ${economiaMensal.toLocaleString('pt-BR', formatOpt)}/mês é um forte indicativo.</li>`);
            // ... (outras dicas de transição)
        } else { 
            tips.push(`<li><i class="fas fa-lightbulb"></i>Seu regime atual (<strong class="text-sky-300">${regimeAtualData.nome}</strong>) parece ser o mais adequado nesta simulação, ou a diferença é mínima. Mantenha a boa gestão!</li>`);
        }

        if (simplesExcedeuSublimite && !(simplesExcedeuLimiteTotalUsuario && regimeAtualData.regimeKey === 'simples_nacional')) {
            tips.push(`<li><i class="fas fa-exclamation-triangle"></i><strong>Atenção ao Sublimite do Simples:</strong> Se estiver no Simples Nacional e seu faturamento ultrapassar R$ 3,6 milhões anuais, o ICMS e/ou ISS devem ser recolhidos fora da guia DAS. Verifique com seu contador.</li>`);
        }
        
        // ... (restante das dicas gerais e específicas mantidas)
        if (regimeAtualData.regimeKey === 'simples_nacional' && !simplesExcedeuLimiteTotalUsuario) {
            tips.push(`<li><i class="fas fa-lightbulb"></i>No Simples Nacional: Monitore o Fator R (relação folha/faturamento para serviços), pois ele pode alterar sua alíquota. Verifique se todas as atividades da empresa se enquadram corretamente.</li>`);
            tips.push(`<li><i class="fas fa-lightbulb"></i>Fique atento ao limite de faturamento anual do Simples Nacional (R$ 4,8 milhões) e ao sublimite de R$ 3,6 milhões para ICMS/ISS.</li>`);
        } else if (regimeAtualData.regimeKey === 'lucro_presumido') {
            tips.push(`<li><i class="fas fa-lightbulb"></i>No Lucro Presumido: Revise periodicamente se sua margem de lucro real não está muito abaixo da margem presumida. Mantenha um bom controle de caixa.</li>`);
        } else if (regimeAtualData.regimeKey === 'lucro_real') {
            tips.push(`<li><i class="fas fa-lightbulb"></i>No Lucro Real: Maximize o aproveitamento de créditos de PIS/COFINS. Mantenha documentação rigorosa de todas as despesas dedutíveis.</li>`);
            tips.push(`<li><i class="fas fa-lightbulb"></i>Avalie a possibilidade de compensar prejuízos fiscais de períodos anteriores, se houver.</li>`);
        }
        
        tips.push(`<li><i class="fas fa-lightbulb"></i>Independentemente do resultado, revise anualmente seu planejamento tributário com um contador. A legislação muda e o perfil da sua empresa também.</li>`);
        tips.push(`<li><i class="fas fa-lightbulb"></i>Analise a possibilidade de benefícios fiscais específicos para seu setor ou estado.</li>`);

        tipPointsEl.innerHTML = tips.join('');
    }


    document.getElementById('taxForm').addEventListener('submit', function(event) {
        event.preventDefault();
        document.getElementById('loading').classList.remove('hidden');
        ['results', 'recommendedRegimeCard', 'economiaSection', 'analysisDetails', 'actionableTips'].forEach(id => document.getElementById(id).classList.add('hidden'));

        setTimeout(() => {
            const inputs = {
                faturamentoMensal: getNumericValueFromInput('faturamentoMensal'),
                regimeAtualInput: document.getElementById('regimeAtualInput').value, 
                setor: document.getElementById('setor').value,
                estado: document.getElementById('estado').value,
                folhaSalarial: getNumericValueFromInput('folhaSalarial'),
                numFuncionarios: parseInt(document.getElementById('numFuncionarios').value) || 0,
                comprasInsumos: getNumericValueFromInput('comprasInsumos'),
                despesasOperacionais: getNumericValueFromInput('despesasOperacionais'),
                servicosTerceirosValor: getNumericValueFromInput('servicosTerceirosValor'),
            };

            const rbt12Anual = inputs.faturamentoMensal * 12;
            const mainMessageEl = document.getElementById('mainMessage');
            const resultsEl = document.getElementById('results');
            const formatOpt = { minimumFractionDigits: 2, maximumFractionDigits: 2 };

            let simplesData = calcularSimplesNacional(inputs); 
            const presumidoData = calcularLucroPresumido(inputs);
            const realData = calcularLucroReal(inputs);

            let regimeAtualInformadoData;
            if (inputs.regimeAtualInput === 'simples_nacional') regimeAtualInformadoData = simplesData;
            else if (inputs.regimeAtualInput === 'lucro_presumido') regimeAtualInformadoData = presumidoData;
            else regimeAtualInformadoData = realData;
            
            document.getElementById('currentRegimeName').textContent = regimeAtualInformadoData.nome;
            document.getElementById('currentTaxMonthly').textContent = regimeAtualInformadoData.mensal !== Infinity ? regimeAtualInformadoData.mensal.toLocaleString('pt-BR', formatOpt) : "N/A (Limite Excedido)";
            document.getElementById('currentTaxAnnual').textContent = regimeAtualInformadoData.anual !== Infinity ? regimeAtualInformadoData.anual.toLocaleString('pt-BR', formatOpt) : "N/A";
            document.getElementById('currentAliqEfetiva').textContent = regimeAtualInformadoData.aliquotaEfetiva.toFixed(2);

            let regimesConsideradosParaRecomendacao = [presumidoData, realData];
            if (!simplesData.excedeuLimiteTotal) {
                regimesConsideradosParaRecomendacao.push(simplesData);
            }
            
            // Se o regime atual do usuário for Simples Nacional e ele excedeu o limite, 
            // o regimeMaisAdequadoData será entre Presumido e Real.
            // Caso contrário, considera todos os regimes válidos.
            let regimeMaisAdequadoData;
            if (inputs.regimeAtualInput === 'simples_nacional' && simplesData.excedeuLimiteTotal) {
                const regimesValidosSNExcedido = [presumidoData, realData].filter(r => r.mensal !== Infinity);
                if (regimesValidosSNExcedido.length === 0) {
                     mainMessageEl.innerHTML = `<p class="text-red-400 text-xl font-semibold">Atenção: Faturamento Anual Excede o Limite do Simples Nacional!</p>
                                         <p class="text-slate-300 mt-2">Além disso, não foi possível simular outros regimes adequadamente. Verifique os dados.</p>`;
                    mainMessageEl.className = 'mb-6 text-center p-4 rounded-lg bg-red-900/30 border border-red-700';
                    document.getElementById('loading').classList.add('hidden');
                    resultsEl.classList.remove('hidden');
                    return;
                }
                regimeMaisAdequadoData = regimesValidosSNExcedido.reduce((min, p) => p.mensal < min.mensal ? p : min, regimesValidosSNExcedido[0]);
                mainMessageEl.innerHTML = `<p class="text-red-400 text-xl font-semibold">Atenção: Faturamento Anual Excede o Limite do Simples Nacional!</p>
                                         <p class="text-slate-300 mt-2">Com um faturamento anual de R$ ${(rbt12Anual).toLocaleString('pt-BR', formatOpt)}, sua empresa ultrapassa o teto de R$ 4.800.000,00 para o Simples Nacional. Este regime não é uma opção válida e pode gerar problemas fiscais.</p>
                                         <p class="text-slate-300 mt-2">O regime recomendado para sua empresa, entre Lucro Presumido e Lucro Real, é <strong class="text-green-300">${regimeMaisAdequadoData.nome}</strong>.</p>`;
                mainMessageEl.className = 'mb-6 text-center p-4 rounded-lg bg-red-900/30 border border-red-700';
            } else {
                regimeMaisAdequadoData = regimesConsideradosParaRecomendacao.reduce((min, p) => p.mensal < min.mensal ? p : min, regimesConsideradosParaRecomendacao[0]);
                 if (regimeAtualInformadoData.regimeKey !== regimeMaisAdequadoData.regimeKey && (regimeAtualInformadoData.mensal - regimeMaisAdequadoData.mensal > 0.01)) { 
                    mainMessageEl.innerHTML = `<p class="text-green-300 text-xl">Boa notícia! Encontramos uma oportunidade de economia para sua empresa.</p><p class="text-slate-300 mt-1">O regime <strong class="text-sky-300">${regimeMaisAdequadoData.nome}</strong> parece ser mais vantajoso.</p>`;
                    mainMessageEl.className = 'mb-6 text-center p-4 rounded-lg bg-green-800/30 border border-green-700';
                } else { 
                    mainMessageEl.innerHTML = `<p class="text-sky-300 text-xl">Análise Concluída!</p><p class="text-slate-300 mt-1">Pelos dados informados, seu regime atual (<strong class="text-sky-300">${regimeAtualInformadoData.nome}</strong>) já parece ser o mais adequado para sua empresa ou a diferença é mínima.</p>`;
                    if (simplesData.excedeuSublimite && regimeAtualInformadoData.regimeKey === 'simples_nacional') { // Mostra aviso de sublimite se SN é o atual e excedeu
                         mainMessageEl.innerHTML += `<p class="text-amber-300 mt-1"><strong>Atenção:</strong> Seu faturamento ultrapassa o sublimite do Simples Nacional para ICMS/ISS, o que requer recolhimento complementar e pode impactar a vantagem deste regime. Veja as dicas.</p>`;
                    }
                    mainMessageEl.className = 'mb-6 text-center p-4 rounded-lg bg-sky-800/30 border border-sky-700';
                }
            }
            
            const economiaMensal = regimeAtualInformadoData.mensal - regimeMaisAdequadoData.mensal;

            // Exibe card do regime recomendado e economia SE HOUVER MUDANÇA VANTAJOSA
            // ou se o regime atual era SN e excedeu o limite, mostrando o recomendado (LP ou LR)
            if ((economiaMensal > 0.01 && regimeAtualInformadoData.regimeKey !== regimeMaisAdequadoData.regimeKey) || (inputs.regimeAtualInput === 'simples_nacional' && simplesData.excedeuLimiteTotal) ) {
                document.getElementById('recommendedRegimeName').textContent = regimeMaisAdequadoData.nome;
                document.getElementById('recommendedTaxMonthly').textContent = regimeMaisAdequadoData.mensal.toLocaleString('pt-BR', formatOpt);
                document.getElementById('recommendedTaxAnnual').textContent = regimeMaisAdequadoData.anual.toLocaleString('pt-BR', formatOpt);
                document.getElementById('recommendedAliqEfetiva').textContent = regimeMaisAdequadoData.aliquotaEfetiva.toFixed(2);
                document.getElementById('recommendedRegimeCard').classList.remove('hidden');

                // Só mostra economia se o regime atual era válido e diferente do recomendado
                if (regimeAtualInformadoData.mensal !== Infinity && regimeAtualInformadoData.regimeKey !== regimeMaisAdequadoData.regimeKey && economiaMensal > 0.01) {
                    const economiaAnual = economiaMensal * 12;
                    let economiaPercentual = 0;
                    if (regimeAtualInformadoData.mensal > 0) {
                        economiaPercentual = (economiaMensal / regimeAtualInformadoData.mensal) * 100;
                    }
                    document.getElementById('economiaValor').textContent = economiaMensal.toLocaleString('pt-BR', formatOpt);
                    document.getElementById('economiaPercentual').textContent = economiaPercentual.toFixed(2);
                    document.getElementById('economiaAnual').textContent = economiaAnual.toLocaleString('pt-BR', formatOpt);
                    document.getElementById('economiaSection').classList.remove('hidden');
                } else {
                    document.getElementById('economiaSection').classList.add('hidden');
                }
            } else {
                 document.getElementById('recommendedRegimeCard').classList.add('hidden');
                 document.getElementById('economiaSection').classList.add('hidden');
            }
            
            gerarAnaliseDetalhada(inputs, regimeAtualInformadoData, regimeMaisAdequadoData, economiaMensal, simplesData.excedeuSublimite, (inputs.regimeAtualInput === 'simples_nacional' && simplesData.excedeuLimiteTotal));
            document.getElementById('analysisDetails').classList.remove('hidden');
            
            gerarDicasTributarias(inputs, regimeAtualInformadoData, regimeMaisAdequadoData, economiaMensal, (inputs.regimeAtualInput === 'simples_nacional' && simplesData.excedeuLimiteTotal), simplesData.excedeuSublimite);
            document.getElementById('actionableTips').classList.remove('hidden');

            document.getElementById('loading').classList.add('hidden');
            resultsEl.classList.remove('hidden');
            resultsEl.scrollIntoView({ behavior: 'smooth' });
        }, 500);
    });
</script>

</body>
</html>
