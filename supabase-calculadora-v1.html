<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Calculadora de Otimização Tributária Avançada (Supabase)</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   <style>
       body {
           font-family: 'Inter', sans-serif;
           background-color: #111827; /* Tailwind gray-900 */
           color: #d1d5db; /* Tailwind gray-300 */
       }
       .tooltip {
           position: relative;
           display: inline-block;
       }
       .tooltip .tooltiptext {
           visibility: hidden;
           width: 220px;
           background-color: #374151; /* Tailwind gray-700 */
           color: #fff;
           text-align: center;
           border-radius: 6px;
           padding: 8px;
           position: absolute;
           z-index: 50;
           bottom: 130%;
           left: 50%;
           margin-left: -110px;
           opacity: 0;
           transition: opacity 0.3s;
           font-size: 0.75rem;
       }
       .tooltip .tooltiptext::after {
           content: "";
           position: absolute;
           top: 100%;
           left: 50%;
           margin-left: -5px;
           border-width: 5px;
           border-style: solid;
           border-color: #374151 transparent transparent transparent;
       }
       .tooltip:hover .tooltiptext {
           visibility: visible;
           opacity: 1;
       }
       label {
           font-weight: 500;
           color: #9ca3af; /* Tailwind gray-400 */
       }
       .input-field, select {
           background-color: #374151;
           border: 1px solid #6b7280;
           color: #d1d5db;
           border-radius: 0.375rem;
       }
       .input-field:focus, select:focus {
           border-color: #3b82f6;
       }
       .input-field::placeholder {
           color: #6b7280;
       }
       select option {
           background-color: #1f2937;
           color: #d1d5db;
       }
       .card {
           background-color: #1f2937;
           border: 1px solid #374151;
           border-radius: 0.5rem;
           padding: 1.5rem;
           box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
       }
       .results-card h3, #resumoLucroReal h3, #analiseDetalhada h3, #proximosPassos h3, #tabelaComparativaContainer h3, #authContainer h2, #userProfile h3 {
           font-size: 1.125rem;
           font-weight: 600;
           margin-bottom: 0.75rem;
           color: #60a5fa;
       }
       .results-card p, #resumoLucroReal p {
           margin-bottom: 0.25rem;
           color: #9ca3af;
       }
       .results-card strong, #resumoLucroReal strong, #secaoEconomia strong {
            color: #bfdbfe;
       }
       .badge {
           display: inline-block;
           padding: 0.25em 0.6em;
           font-size: 75%;
           font-weight: 700;
           line-height: 1;
           text-align: center;
           white-space: nowrap;
           vertical-align: baseline;
           border-radius: 0.375rem;
       }
       .badge-blue { color: #fff; background-color: #2563eb; }
       .badge-green { color: #fff; background-color: #059669; }
       .badge-red { color: #fff; background-color: #dc2626; }
       .badge-yellow { color: #1f2937; background-color: #f59e0b; }
       .badge-purple { color: #fff; background-color: #7c3aed; }


       ::-webkit-scrollbar { width: 8px; height: 8px; }
       ::-webkit-scrollbar-track { background: #374151; border-radius: 10px; }
       ::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 10px; }
       ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
      
       .comparison-table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
       .comparison-table th, .comparison-table td { border: 1px solid #374151; padding: 0.75rem; text-align: left; font-size: 0.875rem; }
       .comparison-table th { background-color: #374151; color: #e5e7eb; font-weight: 600; }
       .comparison-table td { color: #d1d5db; }
       .highlight-best { background-color: #1e3a8a; color: #eff6ff; font-weight: bold; }
       .highlight-best td { color: #eff6ff !important; }


       #authFormContainer { max-width: 400px; margin: 2rem auto; }
       .auth-toggle-link { color: #60a5fa; cursor: pointer; text-decoration: underline; }
       .auth-toggle-link:hover { color: #93c5fd; }
       .error-message { color: #f87171; font-size: 0.875rem; margin-top: 0.5rem;}
       .success-message { color: #34d399; font-size: 0.875rem; margin-top: 0.5rem;}


       .modal {
           position: fixed;
           left: 0;
           top: 0;
           width: 100%;
           height: 100%;
           background-color: rgba(0,0,0,0.7);
           display: flex;
           justify-content: center;
           align-items: center;
           z-index: 1000;
           opacity: 0;
           visibility: hidden;
           transition: opacity 0.3s ease, visibility 0.3s ease;
       }
       .modal.active {
           opacity: 1;
           visibility: visible;
       }
       .modal-content {
           background-color: #1f2937;
           color: #d1d5db;
           padding: 25px;
           border-radius: 8px;
           box-shadow: 0 0 20px rgba(0,0,0,0.6);
           text-align: center;
           max-width: 90%;
           width: 400px;
       }
       .modal-content p { margin-bottom: 15px; }
       .modal-content button {
           margin-top: 15px;
           padding: 10px 20px;
           background-color: #3b82f6;
           color: white;
           border: none;
           border-radius: 5px;
           cursor: pointer;
           transition: background-color 0.2s;
       }
       .modal-content button:hover { background-color: #2563eb; }
   </style>
</head>
<body class="p-4 md:p-8">
   <div class="container mx-auto max-w-5xl">
       <header class="text-center mb-8">
           <h1 class="text-3xl md:text-4xl font-bold text-blue-400">Calculadora de Otimização Tributária Avançada</h1>
           <p id="subHeaderText" class="text-gray-400 mt-2">Faça login ou registre-se para simular e comparar regimes tributários.</p>
       </header>


       <div id="authContainer" class="card mb-10">
           <div id="authFormContainer">
               <form id="loginForm" class="space-y-4">
                   <h2 class="text-xl font-semibold text-center">Login</h2>
                   <div>
                       <label for="loginEmail" class="block text-sm">Email</label>
                       <input type="email" id="loginEmail" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                   </div>
                   <div>
                       <label for="loginPassword" class="block text-sm">Senha</label>
                       <input type="password" id="loginPassword" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                   </div>
                   <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-800">
                       Entrar
                   </button>
                   <p id="loginError" class="error-message text-center"></p>
                   <p class="text-sm text-center text-gray-400">
                       Não tem uma conta? <span id="showRegister" class="auth-toggle-link">Registre-se</span>
                   </p>
               </form>


               <form id="registerForm" class="space-y-4 hidden">
                   <h2 class="text-xl font-semibold text-center">Registrar</h2>
                   <div>
                       <label for="registerEmail" class="block text-sm">Email</label>
                       <input type="email" id="registerEmail" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                   </div>
                   <div>
                       <label for="registerPassword" class="block text-sm">Senha</label>
                       <input type="password" id="registerPassword" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                   </div>
                    <div>
                       <label for="registerPasswordConfirm" class="block text-sm">Confirmar Senha</label>
                       <input type="password" id="registerPasswordConfirm" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                   </div>
                   <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 focus:ring-offset-gray-800">
                       Registrar
                   </button>
                   <p id="registerError" class="error-message text-center"></p>
                    <p id="registerSuccess" class="success-message text-center"></p>
                   <p class="text-sm text-center text-gray-400">
                       Já tem uma conta? <span id="showLogin" class="auth-toggle-link">Faça Login</span>
                   </p>
               </form>
           </div>
       </div>
      
       <div id="userProfile" class="card mb-6 hidden">
           <div class="flex justify-between items-center">
               <h3 id="welcomeMessage" class="text-lg"></h3>
               <button id="logoutButton" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-gray-800">
                   Sair
               </button>
           </div>
       </div>


       <form id="taxForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10 p-6 card hidden">
           <div class="space-y-4">
               <div>
                   <label for="faturamentoMensal" class="block text-sm">Faturamento Mensal (R$)
                       <span class="tooltip text-gray-500">(?)
                           <span class="tooltiptext">Informe o valor bruto total das vendas de produtos ou serviços no mês.</span>
                       </span>
                   </label>
                   <input type="text" id="faturamentoMensal" name="faturamentoMensal" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
               </div>
               <div>
                   <label for="regimeAtual" class="block text-sm">Seu Regime Tributário Atual
                       <span class="tooltip text-gray-500">(?)
                           <span class="tooltiptext">Selecione o regime tributário em que sua empresa está enquadrada atualmente.</span>
                       </span>
                   </label>
                   <select id="regimeAtual" name="regimeAtual" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                       <option value="Simples Nacional">Simples Nacional</option>
                       <option value="Lucro Presumido">Lucro Presumido</option>
                       <option value="Lucro Real">Lucro Real</option>
                   </select>
               </div>
               <div>
                   <label for="setorAtuacao" class="block text-sm">Setor de Atuação
                       <span class="tooltip text-gray-500">(?)
                           <span class="tooltiptext">Escolha o setor que melhor descreve a atividade principal da sua empresa.</span>
                       </span>
                   </label>
                   <select id="setorAtuacao" name="setorAtuacao" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                       <option value="Comércio">Comércio</option>
                       <option value="Indústria">Indústria</option>
                       <option value="Serviços (Geral)">Serviços (Geral)</option>
                       <option value="Tecnologia (Serviços)">Tecnologia (Serviços)</option>
                       <option value="Construção Civil (Obras)">Construção Civil (Obras)</option>
                       <option value="Alimentação (Venda)">Alimentação (Venda)</option>
                       <option value="Transporte de Passageiros">Transporte de Passageiros</option>
                       <option value="Saúde (Serviços)">Saúde (Serviços)</option>
                   </select>
               </div>
               <div>
                   <label for="estadoUF" class="block text-sm">Estado (UF)
                       <span class="tooltip text-gray-500">(?)
                           <span class="tooltiptext">Selecione o estado onde sua empresa está localizada.</span>
                       </span>
                   </label>
                   <select id="estadoUF" name="estadoUF" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                       <option value="AC">Acre</option><option value="AL">Alagoas</option><option value="AP">Amapá</option><option value="AM">Amazonas</option><option value="BA">Bahia</option><option value="CE">Ceará</option><option value="DF">Distrito Federal</option><option value="ES">Espírito Santo</option><option value="GO">Goiás</option><option value="MA">Maranhão</option><option value="MT">Mato Grosso</option><option value="MS">Mato Grosso do Sul</option><option value="MG">Minas Gerais</option><option value="PA">Pará</option><option value="PB">Paraíba</option><option value="PR">Paraná</option><option value="PE">Pernambuco</option><option value="PI">Piauí</option><option value="RJ">Rio de Janeiro</option><option value="RN">Rio Grande do Norte</option><option value="RS">Rio Grande do Sul</option><option value="RO">Rondônia</option><option value="RR">Roraima</option><option value="SC">Santa Catarina</option><option value="SP">São Paulo</option><option value="SE">Sergipe</option><option value="TO">Tocantins</option>
                   </select>
               </div>
                <div>
                   <label for="gastoFolhaSalarial" class="block text-sm">Gasto Mensal com Folha Salarial (R$)
                        <span class="tooltip text-gray-500">(?)
                           <span class="tooltiptext">Inclua salários, pró-labore e encargos diretos (ex: FGTS). Não inclua INSS Patronal.</span>
                       </span>
                   </label>
                   <input type="text" id="gastoFolhaSalarial" name="gastoFolhaSalarial" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
               </div>
           </div>
           <div class="space-y-4">
               <div>
                   <label for="numeroFuncionarios" class="block text-sm">Número de Funcionários
                       <span class="tooltip text-gray-500">(?)
                           <span class="tooltiptext">Informe o número total de funcionários registrados.</span>
                       </span>
                   </label>
                   <input type="number" id="numeroFuncionarios" name="numeroFuncionarios" required min="0" class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
               </div>
               <div>
                   <label for="custosMercadoriasInsumos" class="block text-sm">Custos de Mercadorias/Insumos Vendidos (CMV/CPV/CSP) (R$)
                       <span class="tooltip text-gray-500">(?)
                           <span class="tooltiptext">Custo direto das mercadorias, produtos ou serviços vendidos. Crucial para Lucro Real.</span>
                       </span>
                   </label>
                   <input type="text" id="custosMercadoriasInsumos" name="custosMercadoriasInsumos" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
               </div>
               <div>
                   <label for="despesasOperacionais" class="block text-sm">Despesas Operacionais Mensais (R$)
                       <span class="tooltip text-gray-500">(?)
                           <span class="tooltiptext">Aluguel, água, luz, marketing, etc. Não inclua folha, CMV/CPV/CSP, ou serviços de PJ já informados.</span>
                       </span>
                   </label>
                   <input type="text" id="despesasOperacionais" name="despesasOperacionais" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
               </div>
               <div>
                   <label for="servicosTomadosPJ" class="block text-sm">Valor de Serviços Tomados de PJ com NF (R$)
                       <span class="tooltip text-gray-500">(?)
                           <span class="tooltiptext">Serviços de outras PJs com NF, que podem gerar crédito de PIS/COFINS no Lucro Real.</span>
                       </span>
                   </label>
                   <input type="text" id="servicosTomadosPJ" name="servicosTomadosPJ" required class="input-field mt-1 block w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
               </div>
           </div>
           <div class="md:col-span-2 text-center mt-4">
               <button type="submit" class="w-full md:w-auto inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-800">
                   Calcular Otimização
               </button>
           </div>
       </form>


       <div id="resultsArea" class="hidden space-y-8">
           <div id="mensagemPrincipal" class="card text-center p-6"></div>
           <div id="tabelaComparativaContainer" class="card">
               <h3>Tabela Comparativa dos Regimes</h3>
               <div class="overflow-x-auto">
                   <table id="tabelaComparativa" class="comparison-table">
                       <thead>
                           <tr>
                               <th>Regime Tributário</th>
                               <th>Imposto Mensal Estimado</th>
                               <th>Alíquota Efetiva</th>
                               <th>Imposto Anual Estimado</th>
                           </tr>
                       </thead>
                       <tbody></tbody>
                   </table>
               </div>
           </div>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
               <div id="cardRegimeAtual" class="card results-card"></div>
               <div id="cardRegimeRecomendado" class="card results-card hidden"></div>
           </div>
           <div id="secaoEconomia" class="card hidden p-6"></div>
           <div id="resumoLucroReal" class="card hidden"></div>
           <div id="analiseDetalhada" class="card"></div>
           <div id="proximosPassos" class="card"></div>
           <div id="detalhamentoImpostosContainer" class="space-y-6"></div>
           <div class="text-center mt-10 space-y-4">
                <a href="https://wa.me/5511999999999?text=Ol%C3%A1%2C%20gostaria%20de%20saber%20mais%20sobre%20consultoria%20tribut%C3%A1ria." target="_blank" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 focus:ring-offset-gray-800">
                   <svg class="w-5 h-5 mr-2 -ml-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zm-4 0H9v2h2V9z" clip-rule="evenodd"></path></svg>
                   Fale com um Consultor
               </a>
               <p class="text-xs text-gray-500 px-4">
                   <strong>Aviso:</strong> Esta calculadora fornece estimativas e tem finalidade educacional. Os cálculos são simplificados e não substituem a análise de um contador profissional. Alíquotas de ICMS, ISS e outras específicas podem variar. Consulte sempre um especialista para decisões financeiras e fiscais. As interpretações de regras complexas, como as do Anexo IV do Simples Nacional, são baseadas nas informações do prompt e podem requerer validação profissional.
               </p>
           </div>
       </div>
   </div>
  
   <div id="infoModal" class="modal">
       <div class="modal-content">
           <p id="modalMessage"></p>
           <button id="closeModalBtn">OK</button>
       </div>
   </div>


   <script type="module">
       // Supabase Client Setup
       // ATENÇÃO: Substitua pelas suas credenciais do Supabase!
       const SUPABASE_URL = 'https://babvsdspzhpncqpldbte.supabase.co';
       const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhYnZzZHNwemhwbmNxcGxkYnRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzNzQwNTEsImV4cCI6MjA2Mzk1MDA1MX0.b51Dx0hz6jmUlbP4ymAD2Wp_cPN3lpKkKE8Ypd0ytrc';


       let supabase = null;
       if (SUPABASE_URL !== 'COLOQUE_AQUI_A_URL_DO_SEU_PROJETO_SUPABASE' && SUPABASE_ANON_KEY !== 'COLOQUE_AQUI_A_SUA_CHAVE_ANON_PUBLICA_SUPABASE') {
           try {
               supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
               console.log("Supabase client initialized.");
           } catch (e) {
               console.error("Error initializing Supabase client:", e);
               const authFormContainer = document.getElementById('authFormContainer');
               if(authFormContainer) authFormContainer.innerHTML = '<p class="text-center error-message">Erro na configuração do Supabase. Funcionalidades de login indisponíveis.</p>';
           }
       } else {
           console.warn("Supabase URL or Anon Key is not configured. Please update it with your project's credentials. Auth will not work.");
           const authFormContainer = document.getElementById('authFormContainer');
           if(authFormContainer) authFormContainer.innerHTML = '<p class="text-center error-message">Configuração do Supabase ausente. Funcionalidades de login indisponíveis.</p>';
       }


       // DOM Elements
       const authContainer = document.getElementById('authContainer');
       const loginForm = document.getElementById('loginForm');
       const registerForm = document.getElementById('registerForm');
       const showRegisterLink = document.getElementById('showRegister');
       const showLoginLink = document.getElementById('showLogin');
       const loginErrorEl = document.getElementById('loginError');
       const registerErrorEl = document.getElementById('registerError');
       const registerSuccessEl = document.getElementById('registerSuccess');
      
       const userProfileEl = document.getElementById('userProfile');
       const welcomeMessageEl = document.getElementById('welcomeMessage');
       const logoutButton = document.getElementById('logoutButton');
      
       const taxFormContainer = document.getElementById('taxForm');
       const resultsArea = document.getElementById('resultsArea');
       const subHeaderText = document.getElementById('subHeaderText');


       const infoModal = document.getElementById('infoModal');
       const modalMessageEl = document.getElementById('modalMessage');
       const closeModalBtn = document.getElementById('closeModalBtn');


       function showModal(message) {
           if(modalMessageEl) modalMessageEl.textContent = message;
           if(infoModal) infoModal.classList.add('active');
       }
       if(closeModalBtn) closeModalBtn.onclick = () => { if(infoModal) infoModal.classList.remove('active'); };


       if(showRegisterLink) showRegisterLink.addEventListener('click', () => {
           if(loginForm) loginForm.classList.add('hidden');
           if(registerForm) registerForm.classList.remove('hidden');
           if(loginErrorEl) loginErrorEl.textContent = '';
           if(registerErrorEl) registerErrorEl.textContent = '';
           if(registerSuccessEl) registerSuccessEl.textContent = '';
       });


       if(showLoginLink) showLoginLink.addEventListener('click', () => {
           if(registerForm) registerForm.classList.add('hidden');
           if(loginForm) loginForm.classList.remove('hidden');
           if(loginErrorEl) loginErrorEl.textContent = '';
           if(registerErrorEl) registerErrorEl.textContent = '';
           if(registerSuccessEl) registerSuccessEl.textContent = '';
       });


       // Handle Registration with Supabase
       if (registerForm && supabase) {
           registerForm.addEventListener('submit', async (e) => {
               e.preventDefault();
               const email = document.getElementById('registerEmail').value;
               const password = document.getElementById('registerPassword').value;
               const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
               if(registerErrorEl) registerErrorEl.textContent = '';
               if(registerSuccessEl) registerSuccessEl.textContent = '';


               if (password !== passwordConfirm) {
                   if(registerErrorEl) registerErrorEl.textContent = "As senhas não coincidem.";
                   return;
               }
               if (password.length < 6) { // Supabase default password length
                   if(registerErrorEl) registerErrorEl.textContent = "A senha deve ter pelo menos 6 caracteres.";
                   return;
               }


               const { data, error } = await supabase.auth.signUp({
                   email: email,
                   password: password,
               });


               if (error) {
                   console.error("Error registering with Supabase:", error);
                   if(registerErrorEl) registerErrorEl.textContent = error.message || "Erro ao registrar.";
               } else if (data.user && data.session === null) { // User created, but needs email confirmation
                   if(registerSuccessEl) registerSuccessEl.textContent = "Registro realizado! Verifique seu email para confirmar a conta antes de fazer login.";
                   registerForm.reset();
               } else if (data.user && data.session) { // User created and logged in (if email confirmation is off or auto-confirmed)
                    if(registerSuccessEl) registerSuccessEl.textContent = "Registro e login bem-sucedidos!";
                   registerForm.reset();
               } else {
                   if(registerSuccessEl) registerSuccessEl.textContent = "Registro enviado. Verifique seu email para confirmação, se necessário.";
                   registerForm.reset();
               }
           });
       }


       // Handle Login with Supabase
       if (loginForm && supabase) {
           loginForm.addEventListener('submit', async (e) => {
               e.preventDefault();
               const email = document.getElementById('loginEmail').value;
               const password = document.getElementById('loginPassword').value;
               if(loginErrorEl) loginErrorEl.textContent = '';


               const { data, error } = await supabase.auth.signInWithPassword({
                   email: email,
                   password: password,
               });


               if (error) {
                   console.error("Error logging in with Supabase:", error);
                   if(loginErrorEl) loginErrorEl.textContent = error.message || "Email ou senha inválidos.";
               } else {
                   // Auth state change will handle UI updates
                   console.log("Login successful with Supabase:", data.user);
               }
           });
       }
      
       // Handle Logout with Supabase
       if (logoutButton && supabase) {
           logoutButton.addEventListener('click', async () => {
               const { error } = await supabase.auth.signOut();
               if (error) {
                   console.error("Error logging out with Supabase:", error);
                   showModal("Erro ao sair: " + error.message);
               } else {
                   if(resultsArea) resultsArea.classList.add('hidden');
                   console.log("Logout successful with Supabase");
               }
           });
       }


       // Supabase Auth State Listener
       if (supabase) {
           supabase.auth.onAuthStateChange(async (event, session) => {
               const user = session?.user ?? null;
              
               const welcomeMessageEl = document.getElementById('welcomeMessage');
               const subHeaderText = document.getElementById('subHeaderText');
               const resultsArea = document.getElementById('resultsArea'); // Ensure this is defined
               const loginFormEl = document.getElementById('loginForm');
               const registerFormEl = document.getElementById('registerForm');


               if (user) {
                   // User is signed in
                   if(authContainer) authContainer.classList.add('hidden');
                   if(userProfileEl) userProfileEl.classList.remove('hidden');
                   if(taxFormContainer) taxFormContainer.classList.remove('hidden');
                   if(welcomeMessageEl) welcomeMessageEl.textContent = `Bem-vindo(a), ${user.email}!`;
                   if(subHeaderText) subHeaderText.textContent = "Simule e compare regimes tributários para sua empresa.";
               } else {
                   // User is signed out
                   if(authContainer) authContainer.classList.remove('hidden');
                   if(userProfileEl) userProfileEl.classList.add('hidden');
                   if(taxFormContainer) taxFormContainer.classList.add('hidden');
                   if(resultsArea) resultsArea.classList.add('hidden');
                   if(welcomeMessageEl) welcomeMessageEl.textContent = '';
                   if(subHeaderText) subHeaderText.textContent = "Faça login ou registre-se para simular e comparar regimes tributários.";
                   if (loginFormEl) loginFormEl.reset();
                   if (registerFormEl) registerFormEl.reset();
               }
           });
       }


       // --- Funções Utilitárias (formatCurrency, parseCurrency) ---
       function formatCurrency(value) {
           if (isNaN(value) || value === null || !isFinite(value)) return "N/A";
           return `R$ ${value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
       }


       function parseCurrency(value) {
           if (typeof value !== 'string') return 0;
           const num = parseFloat(value.replace(/\./g, '').replace(',', '.').replace('R$', '').trim());
           return isNaN(num) ? 0 : num;
       }


       const currencyFieldsIds = ['faturamentoMensal', 'gastoFolhaSalarial', 'custosMercadoriasInsumos', 'despesasOperacionais', 'servicosTomadosPJ'];
       currencyFieldsIds.forEach(id => {
           const field = document.getElementById(id);
           if (field) {
               field.addEventListener('input', (e) => {
                   let value = e.target.value.replace(/\D/g, '');
                   if (value === '') {
                       e.target.value = '';
                       return;
                   }
                   if (e.target.value.length > 0 && value.length > 0) {
                       value = (parseInt(value) / 100).toFixed(2);
                        e.target.value = parseFloat(value).toLocaleString('pt-BR', { minimumFractionDigits: 2 }).replace('.', '_TEMP_').replace(',', '.').replace('_TEMP_', ',');
                   } else {
                       e.target.value = '';
                   }
               });
                field.addEventListener('blur', (e) => {
                   let value = e.target.value.replace(/\D/g, '');
                    if (value !== '' && !isNaN(parseInt(value))) {
                       const numValue = parseInt(value) / 100;
                       e.target.value = numValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2});
                    } else if (e.target.value.trim() !== ''){
                        const parsed = parseFloat(e.target.value.replace(/\./g, '').replace(',', '.'));
                        if(!isNaN(parsed)){
                           e.target.value = parsed.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2});
                        } else {
                           e.target.value = '';
                        }
                    } else {
                        e.target.value = '';
                    }
               });
           }
       });
      
       const anexoI_Comercio = [];
       const anexoII_Industria = [];
       const anexoIII_Servicos = [];
       const anexoIV_ServicosObras = [];
       const anexoV_ServicosFatorR = [];
       Object.assign(anexoI_Comercio, [ { rbt12Ate: 180000, aliquota: 0.0400, deduzir: 0 }, { rbt12Ate: 360000, aliquota: 0.0730, deduzir: 5940.00 }, { rbt12Ate: 720000, aliquota: 0.0950, deduzir: 13860.00 }, { rbt12Ate: 1800000, aliquota: 0.1070, deduzir: 22500.00 }, { rbt12Ate: 3600000, aliquota: 0.1430, deduzir: 87300.00 }, { rbt12Ate: 4800000, aliquota: 0.1900, deduzir: 378000.00 } ]);
       Object.assign(anexoII_Industria, [ { rbt12Ate: 180000, aliquota: 0.0450, deduzir: 0 }, { rbt12Ate: 360000, aliquota: 0.0780, deduzir: 5940.00 }, { rbt12Ate: 720000, aliquota: 0.1000, deduzir: 13860.00 }, { rbt12Ate: 1800000, aliquota: 0.1120, deduzir: 22500.00 }, { rbt12Ate: 3600000, aliquota: 0.1470, deduzir: 85500.00 }, { rbt12Ate: 4800000, aliquota: 0.3000, deduzir: 720000.00 } ]);
       Object.assign(anexoIII_Servicos, [ { rbt12Ate: 180000, aliquota: 0.0600, deduzir: 0 }, { rbt12Ate: 360000, aliquota: 0.1120, deduzir: 9360.00 }, { rbt12Ate: 720000, aliquota: 0.1350, deduzir: 17640.00 }, { rbt12Ate: 1800000, aliquota: 0.1600, deduzir: 35640.00 }, { rbt12Ate: 3600000, aliquota: 0.2100, deduzir: 125640.00 }, { rbt12Ate: 4800000, aliquota: 0.3300, deduzir: 648000.00 } ]);
       Object.assign(anexoIV_ServicosObras, [ { rbt12Ate: 180000, aliquota: 0.0450, deduzir: 0 }, { rbt12Ate: 360000, aliquota: 0.0900, deduzir: 8100.00 }, { rbt12Ate: 720000, aliquota: 0.1020, deduzir: 12420.00 }, { rbt12Ate: 1800000, aliquota: 0.1400, deduzir: 39780.00 }, { rbt12Ate: 3600000, aliquota: 0.2200, deduzir: 183780.00 }, { rbt12Ate: 4800000, aliquota: 0.3300, deduzir: 828000.00 } ]);
       Object.assign(anexoV_ServicosFatorR, [ { rbt12Ate: 180000, aliquota: 0.1550, deduzir: 0 }, { rbt12Ate: 360000, aliquota: 0.1800, deduzir: 4500.00 }, { rbt12Ate: 720000, aliquota: 0.1950, deduzir: 9900.00 }, { rbt12Ate: 1800000, aliquota: 0.2050, deduzir: 17100.00 }, { rbt12Ate: 3600000, aliquota: 0.2300, deduzir: 62100.00 }, { rbt12Ate: 4800000, aliquota: 0.3050, deduzir: 540000.00 } ]);


       function calcularSimplesNacional(inputs) {
           const { faturamentoMensal, gastoFolhaSalarial, setorAtuacao } = inputs;
           const rbt12 = faturamentoMensal * 12;
           let resultado = {
               nomeRegime: "Simples Nacional",
               impostoMensalTotal: Infinity,
               aliquotaEfetiva: Infinity,
               impostoAnualEstimado: Infinity,
               aplicavel: true,
               componentes: {
                   das_base: 0,
                   cpp_anexo_iv: 0,
                   iss_anexo_iv_comparativo: 0,
                   icms_por_fora_sublimite: 0,
                   iss_por_fora_sublimite: 0,
                   anexoUtilizado: '',
                   aliquotaEfetivaDASBase: 0
               },
               mensagens: [],
               fatorR: null
           };


           if (rbt12 > 4800000) {
               resultado.aplicavel = false;
               resultado.mensagens.push("Limite máximo de R$ 4,8 milhões/ano excedido para o Simples Nacional.");
               return resultado;
           }


           let anexo, tabelaAnexo;
           let fatorR = null;


           switch (setorAtuacao) {
               case "Comércio":
               case "Alimentação (Venda)":
                   anexo = "Anexo I";
                   tabelaAnexo = anexoI_Comercio;
                   break;
               case "Indústria":
                   anexo = "Anexo II";
                   tabelaAnexo = anexoII_Industria;
                   break;
               case "Transporte de Passageiros":
                   anexo = "Anexo III";
                   tabelaAnexo = anexoIII_Servicos;
                   break;
               case "Serviços (Geral)":
               case "Tecnologia (Serviços)":
               case "Saúde (Serviços)":
                   fatorR = (gastoFolhaSalarial > 0 && faturamentoMensal > 0) ? gastoFolhaSalarial / faturamentoMensal : 0;
                   resultado.fatorR = fatorR;
                   if (fatorR >= 0.28) {
                       anexo = "Anexo III (Fator R >= 0.28)";
                       tabelaAnexo = anexoIII_Servicos;
                   } else {
                       anexo = "Anexo V (Fator R < 0.28)";
                       tabelaAnexo = anexoV_ServicosFatorR;
                   }
                   break;
               case "Construção Civil (Obras)":
                   anexo = "Anexo IV";
                   tabelaAnexo = anexoIV_ServicosObras;
                   break;
               default:
                   resultado.mensagens.push("Setor de atuação não mapeado para Simples Nacional.");
                   resultado.aplicavel = false;
                   return resultado;
           }
           resultado.componentes.anexoUtilizado = anexo;


           const faixa = tabelaAnexo.find(f => rbt12 <= f.rbt12Ate);
           if (!faixa) {
               resultado.mensagens.push("Faixa de RBT12 não encontrada no anexo.");
               resultado.aplicavel = false;
               return resultado;
           }


           const aliquotaNominal = faixa.aliquota;
           const parcelaDeduzir = faixa.deduzir;
           const aliquotaEfetivaDASBase = rbt12 > 0 ? ((rbt12 * aliquotaNominal) - parcelaDeduzir) / rbt12 : 0;
          
           let dasBase = faturamentoMensal * aliquotaEfetivaDASBase;
           resultado.componentes.das_base = dasBase;
           resultado.componentes.aliquotaEfetivaDASBase = aliquotaEfetivaDASBase * 100;


           let cppAnexoIV = 0;
           let icmsPorForaSublimite = 0;
           let issPorForaSublimite = 0;
          
           if (setorAtuacao === "Construção Civil (Obras)") {
               cppAnexoIV = gastoFolhaSalarial * 0.20;
               resultado.componentes.cpp_anexo_iv = cppAnexoIV;
               resultado.componentes.iss_anexo_iv_comparativo = faturamentoMensal * 0.035;
           }
          
           if (rbt12 > 3600000 && rbt12 <= 4800000) {
               resultado.mensagens.push("Atenção: RBT12 excedeu o sublimite de R$ 3,6 milhões. ICMS/ISS podem ser devidos por fora do DAS.");
               if (setorAtuacao === "Comércio" || setorAtuacao === "Indústria" || setorAtuacao === "Alimentação (Venda)") {
                   icmsPorForaSublimite = faturamentoMensal * 0.03;
                   resultado.componentes.icms_por_fora_sublimite = icmsPorForaSublimite;
               } else if (setorAtuacao !== "Construção Civil (Obras)") {
                   issPorForaSublimite = faturamentoMensal * 0.035;
                   resultado.componentes.iss_por_fora_sublimite = issPorForaSublimite;
               }
           }


           let impostoTotalSN = dasBase + cppAnexoIV + icmsPorForaSublimite + issPorForaSublimite;
          
           resultado.impostoMensalTotal = impostoTotalSN;
           resultado.aliquotaEfetiva = (faturamentoMensal > 0) ? (impostoTotalSN / faturamentoMensal) * 100 : 0;
           resultado.impostoAnualEstimado = resultado.impostoMensalTotal * 12;


           return resultado;
       }


       function calcularLucroPresumido(inputs) {
           const { faturamentoMensal, gastoFolhaSalarial, setorAtuacao } = inputs;
           let resultado = {
               nomeRegime: "Lucro Presumido",
               impostoMensalTotal: 0,
               aliquotaEfetiva: 0,
               impostoAnualEstimado: 0,
               aplicavel: true,
               componentes: {
                   pis_cofins: 0,
                   irpj_csll: 0,
                   inss_patronal: 0,
                   outros_impostos: 0,
                   base_irpj: 0,
                   base_csll: 0
               },
               mensagens: []
           };


           let percPresuncaoIRPJ, percPresuncaoCSLL;
           let isServico = false;


           switch (setorAtuacao) {
               case "Comércio":
               case "Indústria":
               case "Alimentação (Venda)":
                   percPresuncaoIRPJ = 0.08;
                   percPresuncaoCSLL = 0.12;
                   break;
               case "Transporte de Passageiros":
                   percPresuncaoIRPJ = 0.16;
                   percPresuncaoCSLL = 0.12;
                   break;
               case "Serviços (Geral)":
               case "Tecnologia (Serviços)":
               case "Construção Civil (Obras)":
               case "Saúde (Serviços)":
                   percPresuncaoIRPJ = 0.32;
                   percPresuncaoCSLL = 0.32;
                   isServico = true;
                   break;
               default:
                   resultado.mensagens.push("Setor de atuação não mapeado para Lucro Presumido.");
                   resultado.aplicavel = false;
                   return resultado;
           }


           const bcpIRPJ = faturamentoMensal * percPresuncaoIRPJ;
           const bcpCSLL = faturamentoMensal * percPresuncaoCSLL;
           resultado.componentes.base_irpj = bcpIRPJ;
           resultado.componentes.base_csll = bcpCSLL;


           let irpjMensal = bcpIRPJ * 0.15;
           if (bcpIRPJ > 20000) {
               irpjMensal += (bcpIRPJ - 20000) * 0.10;
           }
           const csllMensal = bcpCSLL * 0.09;
           resultado.componentes.irpj_csll = irpjMensal + csllMensal;


           const pisMensal = faturamentoMensal * 0.0065;
           const cofinsMensal = faturamentoMensal * 0.03;
           resultado.componentes.pis_cofins = pisMensal + cofinsMensal;


           const inssPatronalLP = gastoFolhaSalarial * 0.20;
           resultado.componentes.inss_patronal = inssPatronalLP;


           let impostoMunicipalEstadual = 0;
           if (isServico) {
               impostoMunicipalEstadual = faturamentoMensal * 0.035;
           } else {
               impostoMunicipalEstadual = faturamentoMensal * 0.03;
           }
           resultado.componentes.outros_impostos = impostoMunicipalEstadual;


           resultado.impostoMensalTotal = (irpjMensal + csllMensal) + (pisMensal + cofinsMensal) + inssPatronalLP + impostoMunicipalEstadual;
           resultado.aliquotaEfetiva = (faturamentoMensal > 0) ? (resultado.impostoMensalTotal / faturamentoMensal) * 100 : 0;
           resultado.impostoAnualEstimado = resultado.impostoMensalTotal * 12;
          
           return resultado;
       }


       function calcularLucroReal(inputs) {
           const { faturamentoMensal, gastoFolhaSalarial, custosMercadoriasInsumos, despesasOperacionais, servicosTomadosPJ, setorAtuacao } = inputs;
            let resultado = {
               nomeRegime: "Lucro Real",
               impostoMensalTotal: 0,
               aliquotaEfetiva: 0,
               impostoAnualEstimado: 0,
               aplicavel: true,
               componentes: {
                   pis_cofins: 0,
                   irpj_csll: 0,
                   inss_patronal: 0,
                   outros_impostos: 0,
                   creditos_pis_cofins_total: 0,
                   lair_apurado: 0
               },
               detalhesLR: {
                   faturamento_bruto_lr: faturamentoMensal,
                   custos_mercadorias_lr: custosMercadoriasInsumos,
                   despesas_folha_lr: gastoFolhaSalarial,
                   despesas_operacionais_lr: despesasOperacionais,
                   pis_cofins_apurado_lr: 0,
                   total_custos_despesas_dedutiveis_lair: 0,
                   lair_apurado: 0
               },
               mensagens: []
           };


           const debitoPIS_LR = faturamentoMensal * 0.0165;
           const debitoCOFINS_LR = faturamentoMensal * 0.076;


           const creditoPIS_Compras = custosMercadoriasInsumos * 0.0165;
           const creditoCOFINS_Compras = custosMercadoriasInsumos * 0.076;
           const creditoPIS_ServicosTomados = servicosTomadosPJ * 0.0165;
           const creditoCOFINS_ServicosTomados = servicosTomadosPJ * 0.076;
          
           resultado.componentes.creditos_pis_cofins_total = creditoPIS_Compras + creditoCOFINS_Compras + creditoPIS_ServicosTomados + creditoCOFINS_ServicosTomados;


           const pisAPagarLR = Math.max(0, debitoPIS_LR - creditoPIS_Compras - creditoPIS_ServicosTomados);
           const cofinsAPagarLR = Math.max(0, debitoCOFINS_LR - creditoCOFINS_Compras - creditoCOFINS_ServicosTomados);
           const totalPISCOFINS_LR_Devido = pisAPagarLR + cofinsAPagarLR;
           resultado.componentes.pis_cofins = totalPISCOFINS_LR_Devido;
           resultado.detalhesLR.pis_cofins_apurado_lr = totalPISCOFINS_LR_Devido;


           const custosDedutiveisLAIR = custosMercadoriasInsumos;
           const despesasOperacionaisDedutiveisLAIR = despesasOperacionais + gastoFolhaSalarial;
           const pisCofinsDedutivelLAIR = totalPISCOFINS_LR_Devido;
           const lair = faturamentoMensal - custosDedutiveisLAIR - despesasOperacionaisDedutiveisLAIR - pisCofinsDedutivelLAIR;
           resultado.componentes.lair_apurado = lair;
           resultado.detalhesLR.lair_apurado = lair;
           resultado.detalhesLR.total_custos_despesas_dedutiveis_lair = custosDedutiveisLAIR + despesasOperacionaisDedutiveisLAIR + pisCofinsDedutivelLAIR;


           let irpjLRMensal = 0;
           let csllLRMensal = 0;
           if (lair > 0) {
               irpjLRMensal = lair * 0.15;
               if (lair > 20000) {
                   irpjLRMensal += (lair - 20000) * 0.10;
               }
               csllLRMensal = lair * 0.09;
           }
           resultado.componentes.irpj_csll = irpjLRMensal + csllLRMensal;


           const inssPatronalLR = gastoFolhaSalarial * 0.20;
           resultado.componentes.inss_patronal = inssPatronalLR;


           let impostoEstadualMunicipalLR = 0;
           let isServicoLR = ["Serviços (Geral)", "Tecnologia (Serviços)", "Construção Civil (Obras)", "Saúde (Serviços)", "Transporte de Passageiros"].includes(setorAtuacao);


           if (isServicoLR) {
               impostoEstadualMunicipalLR = faturamentoMensal * 0.035;
           } else {
               const icmsDebito = faturamentoMensal * 0.18;
               const icmsCredito = custosMercadoriasInsumos * 0.18;
               impostoEstadualMunicipalLR = Math.max(0, icmsDebito - icmsCredito);
           }
           resultado.componentes.outros_impostos = impostoEstadualMunicipalLR;


           resultado.impostoMensalTotal = irpjLRMensal + csllLRMensal + totalPISCOFINS_LR_Devido + inssPatronalLR + impostoEstadualMunicipalLR;
           resultado.aliquotaEfetiva = (faturamentoMensal > 0) ? (resultado.impostoMensalTotal / faturamentoMensal) * 100 : 0;
           resultado.impostoAnualEstimado = resultado.impostoMensalTotal * 12;


           if (lair <= 0) {
               resultado.mensagens.push("LAIR (Lucro Real) negativo ou zero. IRPJ e CSLL não são devidos sobre o lucro, mas outros impostos (PIS, COFINS, INSS, ICMS/ISS) podem incidir.");
           }
           return resultado;
       }


       function displayResults(inputs, resultados) {
           const { simples, presumido, real } = resultados;
          
           let regimesValidos = [simples, presumido, real].filter(r => r.aplicavel && isFinite(r.impostoMensalTotal));
           regimesValidos.sort((a, b) => a.impostoMensalTotal - b.impostoMensalTotal);
          
           const regimeRecomendado = regimesValidos.length > 0 ? regimesValidos[0] : null;


           const tabelaCorpo = document.getElementById('tabelaComparativa').getElementsByTagName('tbody')[0];
           tabelaCorpo.innerHTML = '';
           [simples, presumido, real].forEach(reg => {
               const row = tabelaCorpo.insertRow();
               row.insertCell().textContent = reg.nomeRegime + (!reg.aplicavel ? " (Inválido)" : "");
               row.insertCell().textContent = reg.aplicavel ? formatCurrency(reg.impostoMensalTotal) : "N/A";
               row.insertCell().textContent = reg.aplicavel && isFinite(reg.aliquotaEfetiva) ? reg.aliquotaEfetiva.toFixed(2) + '%' : "N/A";
               row.insertCell().textContent = reg.aplicavel ? formatCurrency(reg.impostoAnualEstimado) : "N/A";


               if (regimeRecomendado && reg.nomeRegime === regimeRecomendado.nomeRegime && reg.aplicavel) {
                   row.classList.add('highlight-best');
               }
               if (!reg.aplicavel) {
                   row.style.color = "#ef4444";
                   row.style.fontStyle = "italic";
               }
           });


           let regimeAtualCalculado;
           if (inputs.
